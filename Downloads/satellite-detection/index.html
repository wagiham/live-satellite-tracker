<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Satellite Tracker</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.93/Build/Cesium/Cesium.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/satellite.js/4.0.0/satellite.min.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.93/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 8px;
      border-radius: 4px;
    }
    select {
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div id="controls">
    <label for="satelliteSet">Choose satellite set: </label>
    <select id="satelliteSet">
      <option value="stations">Space Stations</option>
      <option value="active">Active Satellites</option>
      <option value="weather">Weather Satellites</option>
      <option value="starlink">Starlink</option>
    </select>
  </div>

  <div id="cesiumContainer"></div>
  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhZjMwYTQ1MC02MDhhLTQ4OGEtYjUzMy0yMTc0M2MxM2UzMzIiLCJpZCI6MzA4MTM4LCJpYXQiOjE3NDg3NTI1OTl9.KVZ87YPd3nxeuJb4m6wxjMlXF3M7HqBsbbqD_mt3D3s';

    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrainProvider: Cesium.createWorldTerrain(),
      shouldAnimate: true,
    });

    const fallbackTLEs = [
      {
        name: "ISS (ZARYA)",
        tle1: "1 25544U 98067A   24151.45745370  .00003347  00000+0  65131-4 0  9992",
        tle2: "2 25544  51.6401 196.1469 0004772 100.9522 320.8123 15.50388912452464"
      }
    ];

    let satellites = [];
    let entities = [];

    function clearSatellites() {
      entities.forEach(entity => viewer.entities.remove(entity));
      entities = [];
    }

    function addSatelliteToCesium(sat) {
      const satrec = satellite.twoline2satrec(sat.tle1, sat.tle2);

      const entity = viewer.entities.add({
        name: sat.name,
        position: new Cesium.CallbackProperty(() => {
          const now = new Date();
          const positionAndVelocity = satellite.propagate(satrec, now);
          const posEci = positionAndVelocity.position;
          if (!posEci || isNaN(posEci.x)) return null;

          const gmst = satellite.gstime(now);
          const posGd = satellite.eciToGeodetic(posEci, gmst);
          if (!posGd) return null;

          return Cesium.Cartesian3.fromDegrees(
            Cesium.Math.toDegrees(posGd.longitude),
            Cesium.Math.toDegrees(posGd.latitude),
            posGd.height * 1000
          );
        }, false),
        point: { pixelSize: 6, color: Cesium.Color.RED },
        label: {
          text: sat.name,
          font: "14px sans-serif",
          fillColor: Cesium.Color.WHITE,
          outlineColor: Cesium.Color.BLACK,
          outlineWidth: 2,
          pixelOffset: new Cesium.Cartesian2(10, 0),
          style: Cesium.LabelStyle.FILL_AND_OUTLINE
        }
      });
      entities.push(entity);
    }

    async function fetchTLEs(set = "stations") {
      const urls = {
        stations: "https://celestrak.com/NORAD/elements/gp.php?GROUP=stations&FORMAT=tle",
        active: "https://celestrak.com/NORAD/elements/gp.php?GROUP=active&FORMAT=tle",
        weather: "https://celestrak.com/NORAD/elements/gp.php?GROUP=weather&FORMAT=tle",
        starlink: "https://celestrak.com/NORAD/elements/gp.php?GROUP=starlink&FORMAT=tle",
      };

      try {
        const res = await fetch(urls[set]);
        const text = await res.text();
        const lines = text.trim().split("\n");

        const parsed = [];
        for (let i = 0; i < lines.length; i += 3) {
          const name = lines[i]?.trim();
          const tle1 = lines[i + 1];
          const tle2 = lines[i + 2];
          if (name && tle1 && tle2) parsed.push({ name, tle1, tle2 });
        }

        if (parsed.length === 0) {
          console.warn("No valid satellites parsed. Using fallback.");
          fallbackTLEs.forEach(addSatelliteToCesium);
        } else {
          parsed.slice(0, 100).forEach(addSatelliteToCesium);
        }
      } catch (err) {
        console.error("TLE fetch failed, using fallback", err);
        fallbackTLEs.forEach(addSatelliteToCesium);
      }
    }

    document.getElementById("satelliteSet").addEventListener("change", e => {
      clearSatellites();
      fetchTLEs(e.target.value);
    });

    fetchTLEs();
  </script>
</body>
</html>
